<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>èº«ä½“éš¾åº¦ä¸è¿åŠ¨å‘˜æ·±åº¦åˆ†ææŠ¥å‘Š â€” AI ä½“æ“è£åˆ¤</title>
  <link rel="stylesheet" href="/styles/common.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    .report-section { margin-bottom: 2rem; }
    .report-section h2 { font-size: 1.25rem; color: var(--accent); margin-bottom: 0.75rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem; }
    .element-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; padding: 1rem 1.25rem; margin-bottom: 0.75rem; }
    .element-card .name { font-weight: 600; margin-bottom: 0.5rem; }
    .element-card .scores { display: flex; gap: 1rem; margin-bottom: 0.75rem; flex-wrap: wrap; }
    .element-card .score-mini { font-size: 0.85rem; color: var(--text-muted); }
    .element-card .score-mini .d { color: var(--accent); font-weight: 600; }
    .element-card .score-mini .e { color: var(--danger); font-weight: 600; }
    .element-card .pro { color: var(--success); margin: 0.25rem 0; }
    .element-card .con { color: var(--danger); margin: 0.25rem 0; }
    .element-card .comment { color: var(--text-muted); font-size: 0.95rem; margin-top: 0.5rem; }
    .radar-wrap { max-width: 420px; margin: 1.5rem auto; padding: 1.5rem; background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border); }
    .radar-wrap canvas { display: block; margin: 0 auto; }
    .report-content p { margin: 0 0 1rem 0; }
    .report-content p:last-child { margin-bottom: 0; }
    .report-content strong { color: var(--text-primary); font-weight: 600; }
    .report-content .para-block { margin-bottom: 1.25rem; }
    .chat-section { margin-top: 2.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border); }
    .chat-section h2 { font-size: 1.15rem; color: var(--accent); margin-bottom: 0.75rem; }
    .chat-messages { background: var(--bg-dark); border: 1px solid var(--border); border-radius: 12px; min-height: 120px; max-height: 320px; overflow-y: auto; padding: 1rem; margin-bottom: 0.75rem; }
    .chat-message { margin-bottom: 0.75rem; display: flex; }
    .chat-message.user { justify-content: flex-end; }
    .chat-message .bubble { max-width: 85%; padding: 0.6rem 1rem; border-radius: 12px; line-height: 1.5; white-space: pre-wrap; word-break: break-word; }
    .chat-message.user .bubble { background: var(--accent); color: #fff; border-bottom-right-radius: 4px; }
    .chat-message.model .bubble { background: var(--bg-card); border: 1px solid var(--border); border-bottom-left-radius: 4px; }
    .chat-typing { color: var(--text-muted); font-size: 0.9rem; padding: 0.5rem 0; }
    .chat-input-row { display: flex; gap: 0.5rem; align-items: stretch; }
    .chat-input-row input { flex: 1; padding: 0.65rem 1rem; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-card); color: var(--text-primary); font-size: 1rem; }
    .chat-input-row input::placeholder { color: var(--text-muted); }
    .chat-input-row button { padding: 0.65rem 1.25rem; border-radius: 8px; background: var(--accent); color: #fff; border: none; font-weight: 600; cursor: pointer; }
    .chat-input-row button:disabled { opacity: 0.6; cursor: not-allowed; }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="page-title">èº«ä½“éš¾åº¦ä¸è¿åŠ¨å‘˜æ·±åº¦åˆ†ææŠ¥å‘Š</h1>
    <p class="page-subtitle">åé¦ˆæŠ¥å‘Šå½¢å¼3ï¼šå››ç»´åº¦ç”»åƒä¸è¿åŠ¨å‘˜ç”»åƒ</p>
    <div id="no-data" class="loading" style="display:none;">æš‚æ— æ•´ä½“æŠ¥å‘Šæ•°æ®ï¼Œè¯·å…ˆå®Œæˆã€Œè¿åŠ¨å‘˜æ•´ä½“æŠ¥å‘Šã€æµç¨‹ã€‚</div>
    <div id="report-body" style="display:none;">
      <section class="report-section" id="section-per-element">
        <h2>1. å„èº«ä½“éš¾åº¦çš„ä¼˜ç‚¹ä¸ä¸è¶³</h2>
        <div id="per-element-cards"></div>
      </section>
      <section class="report-section" id="section-radar">
        <h2>2. æ ¸å¿ƒç»´åº¦åˆ†æï¼šèº«ä½“éš¾åº¦ (DB) å››ç»´åº¦ç”»åƒ</h2>
        <p style="color: var(--text-muted); font-size: 0.95rem; margin-bottom: 1rem;">
          A å§¿æ€/æŸ”éŸ§æ€§ Â· B åŠ¨åŠ›æ€§/çˆ†å‘åŠ› Â· C æŠ€æœ¯è§„èŒƒ Â· D ç¨³å®šæ€§ï¼ˆè½´å¿ƒ/é‡å¿ƒï¼‰
        </p>
        <div class="radar-wrap">
          <canvas id="radar-chart" width="360" height="360"></canvas>
        </div>
      </section>
      <section class="report-section" id="section-profile">
        <h2>3. è¿åŠ¨å‘˜ç”»åƒï¼šä¼˜åŠ¿ä¸åŠ£åŠ¿</h2>
        <div class="report-content" id="athlete-profile"></div>
      </section>
      <section class="report-section" id="section-guide">
        <h2>4. ç»ƒä¹ å»ºè®®ä¸è®­ç»ƒæŒ‡å—</h2>
        <div class="report-content" id="practice-guide"></div>
      </section>
      <section class="report-section" id="section-full">
        <h2>5. æ€»ä½“æŠ¥å‘Š</h2>
        <div class="report-content" id="full-report"></div>
      </section>
      <section class="report-section chat-section">
        <h2>ğŸ’¬ å¯¹æŠ¥å‘Šæœ‰ç–‘é—®ï¼Ÿå‘ AI æé—®</h2>
        <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 0.75rem;">å¯è¯¢é—®ï¼šå„éš¾åº¦ä¼˜ç¼ºç‚¹ã€å¦‚ä½•æ”¹è¿›ã€è®­ç»ƒå»ºè®®ã€ä¸‹ä¸€æ­¥è®¡åˆ’ç­‰ï¼ŒAI å°†åŸºäºæœ¬è¿åŠ¨å‘˜æ•´ä½“æŠ¥å‘Šå›ç­”ã€‚</p>
        <div class="chat-messages" id="chat-messages"></div>
        <div class="chat-typing" id="chat-typing" style="display:none;">æ­£åœ¨æ€è€ƒâ€¦</div>
        <div class="chat-input-row">
          <input type="text" id="chat-input" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜â€¦" autocomplete="off" />
          <button type="button" id="chat-send">å‘é€</button>
        </div>
      </section>
    </div>
    <div class="nav-links">
      <a href="/select-overall">â† å†åšä¸€æ¬¡æ•´ä½“æŠ¥å‘Š</a>
      <a href="/select-tool">å•æ¬¡åŠ¨ä½œåˆ†æ</a>
      <a href="/">è¿”å›é¦–é¡µ</a>
    </div>
  </div>
  <script>
    const OVERALL_RESULT_KEY = "gymnastics_overall_result";
    const raw = sessionStorage.getItem(OVERALL_RESULT_KEY);
    if (!raw) {
      document.getElementById("no-data").style.display = "block";
    } else {
      try {
        const data = JSON.parse(raw);
        const report = data.overall_report || {};
        document.getElementById("report-body").style.display = "block";

        var perEl = report.per_element || [];
        var perResults = data.per_element_results || [];
        var cardsEl = document.getElementById("per-element-cards");
        cardsEl.innerHTML = perEl.map(function (e, i) {
          var res = perResults[i] || {};
          var d = res.d_score != null ? res.d_score : "â€”";
          var eVal = res.e_score != null ? res.e_score : "â€”";
          var scoreBlock = (d !== "â€”" || eVal !== "â€”") ?
            "<div class=\"scores\"><span class=\"score-mini\">D <span class=\"d\">" + d + "</span></span> <span class=\"score-mini\">E <span class=\"e\">" + eVal + "</span></span></div>" : "";
          return "<div class=\"element-card\">" +
            "<div class=\"name\">" + (e.element_name || "") + "</div>" +
            scoreBlock +
            "<div class=\"pro\">ä¼˜ç‚¹ï¼š " + (e.pro || "â€”") + "</div>" +
            "<div class=\"con\">ä¸è¶³ï¼š " + (e.con || "â€”") + "</div>" +
            "<div class=\"comment\">" + (e.comment || "") + "</div>" +
            "</div>";
        }).join("");

        var radar = report.radar || { A: 5, B: 5, C: 5, D: 5 };
        var labels = ["å§¿æ€ä¸æŸ”éŸ§æ€§ (A)", "åŠ¨åŠ›æ€§ä¸çˆ†å‘åŠ› (B)", "æŠ€æœ¯è§„èŒƒ (C)", "ç¨³å®šæ€§ (D)"];
        var values = [
          Math.max(1, Math.min(10, radar.A)),
          Math.max(1, Math.min(10, radar.B)),
          Math.max(1, Math.min(10, radar.C)),
          Math.max(1, Math.min(10, radar.D))
        ];
        var ctx = document.getElementById("radar-chart").getContext("2d");
        var gridColor = "rgba(148, 163, 184, 0.35)";
        var tickColor = "rgba(241, 245, 249, 0.9)";
        new Chart(ctx, {
          type: "radar",
          data: {
            labels: labels,
            datasets: [{
              label: "èº«ä½“éš¾åº¦ç»´åº¦",
              data: values,
              fill: true,
              backgroundColor: "rgba(59, 130, 246, 0.2)",
              borderColor: "rgba(59, 130, 246, 0.95)",
              borderWidth: 2,
              pointBackgroundColor: "rgba(59, 130, 246, 1)",
              pointBorderColor: "#fff",
              pointBorderWidth: 2,
              pointRadius: 5,
              pointHoverBackgroundColor: "#fff",
              pointHoverBorderColor: "rgba(59, 130, 246, 1)"
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            layout: { padding: 20 },
            scales: {
              r: {
                min: 0,
                max: 10,
                beginAtZero: true,
                ticks: {
                  stepSize: 2,
                  font: { size: 13 },
                  color: tickColor,
                  backdropColor: "transparent",
                  z: 1
                },
                pointLabels: {
                  font: { size: 13 },
                  color: tickColor,
                  padding: 8
                },
                angleLines: {
                  display: true,
                  color: gridColor,
                  lineWidth: 1
                },
                grid: {
                  color: gridColor,
                  circular: true,
                  lineWidth: 1
                }
              }
            },
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: function(ctx) { return ctx.label + "ï¼š " + ctx.raw + " åˆ†"; }
                }
              }
            }
          }
        });

        function formatParagraphs(s) {
          if (!s || !s.trim()) return "<p>â€”</p>";
          var text = s.trim();
          var out = [];
          var blocks = text.split(/\n\n+/);
          blocks.forEach(function(block) {
            block = block.trim();
            if (!block) return;
            if (block.length > 100 && /[ã€‚ï¼ï¼Ÿ]/.test(block)) {
              var sentences = block.match(/[^ã€‚ï¼ï¼Ÿ]+[ã€‚ï¼ï¼Ÿ]?/g) || [];
              sentences.forEach(function(part) {
                part = part.trim();
                if (part) out.push("<p class=\"para-block\">" + part.replace(/\n/g, "<br>") + "</p>");
              });
            } else {
              out.push("<p class=\"para-block\">" + block.replace(/\n/g, "<br>") + "</p>");
            }
          });
          return out.length ? out.join("") : "<p>â€”</p>";
        }
        document.getElementById("athlete-profile").innerHTML = formatParagraphs(report.athlete_profile || "");
        document.getElementById("practice-guide").innerHTML = formatParagraphs(report.practice_guide || "");
        document.getElementById("full-report").innerHTML = formatParagraphs(report.full_report || "");

        // Build plain-text report context for chat (same order as displayed)
        var contextParts = [];
        if (perEl.length) {
          contextParts.push("ã€å„èº«ä½“éš¾åº¦çš„ä¼˜ç‚¹ä¸ä¸è¶³ã€‘");
          perEl.forEach(function (e, i) {
            contextParts.push((e.element_name || "åŠ¨ä½œ") + "ï¼šä¼˜ç‚¹ " + (e.pro || "â€”") + "ï¼›ä¸è¶³ " + (e.con || "â€”") + "ã€‚" + (e.comment || ""));
          });
        }
        contextParts.push("\nã€è¿åŠ¨å‘˜ç”»åƒï¼šä¼˜åŠ¿ä¸åŠ£åŠ¿ã€‘\n" + (report.athlete_profile || "â€”"));
        contextParts.push("\nã€ç»ƒä¹ å»ºè®®ä¸è®­ç»ƒæŒ‡å—ã€‘\n" + (report.practice_guide || "â€”"));
        contextParts.push("\nã€æ€»ä½“æŠ¥å‘Šã€‘\n" + (report.full_report || "â€”"));
        window.reportContext = contextParts.join("\n");
        window.chatHistory = [];

        var chatMessages = document.getElementById("chat-messages");
        var chatInput = document.getElementById("chat-input");
        var chatSend = document.getElementById("chat-send");
        var chatTyping = document.getElementById("chat-typing");

        function appendMessage(role, content) {
          var wrap = document.createElement("div");
          wrap.className = "chat-message " + (role === "user" ? "user" : "model");
          var bubble = document.createElement("div");
          bubble.className = "bubble";
          bubble.textContent = content;
          wrap.appendChild(bubble);
          chatMessages.appendChild(wrap);
          chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        function setTyping(show) {
          chatTyping.style.display = show ? "block" : "none";
          chatSend.disabled = show;
          if (show) chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        async function sendChat() {
          var msg = (chatInput.value || "").trim();
          if (!msg || chatSend.disabled) return;
          chatInput.value = "";
          appendMessage("user", msg);
          window.chatHistory.push({ role: "user", content: msg });
          setTyping(true);
          try {
            var res = await fetch("/api/report-chat", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                report_context: window.reportContext,
                message: msg,
                history: window.chatHistory.slice(0, -1)
              })
            });
            var chatData = await res.json();
            setTyping(false);
            if (res.ok && chatData.reply) {
              appendMessage("model", chatData.reply);
              window.chatHistory.push({ role: "model", content: chatData.reply });
            } else {
              appendMessage("model", "å›å¤å¤±è´¥ï¼š" + (chatData.error || res.statusText));
            }
          } catch (e) {
            setTyping(false);
            appendMessage("model", "è¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚");
          }
        }
        chatSend.addEventListener("click", sendChat);
        chatInput.addEventListener("keydown", function (e) {
          if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); sendChat(); }
        });
      } catch (e) {
        document.getElementById("no-data").style.display = "block";
        document.getElementById("no-data").textContent = "æŠ¥å‘Šæ•°æ®è§£æå¤±è´¥ã€‚";
      }
    }
  </script>
</body>
</html>
