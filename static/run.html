<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>分析结果 — AI 体操裁判</title>
  <link rel="stylesheet" href="/styles/common.css">
  <style>
    .media-container {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 1rem;
      margin: 1rem 0;
      text-align: center;
    }
    .media-container video, .media-container img { max-width: 100%; border-radius: 8px; }
    .report-buttons { display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 1.5rem; }
    .report-buttons .btn { margin-right: 0.5rem; }
    .loading-wrapper { text-align: center; padding: 2rem; }
    .loading-steps { max-width: 420px; margin: 0 auto; text-align: left; }
    .loading-steps-title { font-weight: 600; margin-bottom: 1rem; color: var(--text-primary); }
    .loading-steps-list { list-style: none; padding: 0; margin: 0 0 1rem 0; }
    .loading-steps-list li { padding: 0.5rem 0.75rem; margin: 0.25rem 0; border-radius: 8px; display: flex; align-items: center; gap: 0.75rem; color: var(--text-muted); transition: background 0.2s, color 0.2s; }
    .loading-steps-list li.active { background: rgba(59, 130, 246, 0.15); color: var(--accent); font-weight: 500; }
    .loading-steps-list li.done { color: var(--success); }
    .loading-steps-list .step-spinner { width: 18px; height: 18px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; flex-shrink: 0; }
    .loading-steps-list .step-done { width: 18px; text-align: center; color: var(--success); flex-shrink: 0; }
    .loading-steps-hint { font-size: 0.85rem; color: var(--text-muted); margin-top: 1rem; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="page-title">分析结果</h1>
    <p class="page-subtitle" id="subtitle"></p>
    <div id="loading" class="loading-wrapper">
      <div id="loading-simple" class="loading">正在分析，请稍候…（可能需要 1–2 分钟）</div>
      <div id="loading-steps" class="loading-steps" style="display:none;">
        <p class="loading-steps-title">平衡腿结环 (Penche) 分析中</p>
        <ul class="loading-steps-list" id="loading-steps-list"></ul>
        <p class="loading-steps-hint">若已开启 MediaPipe 窗口，请在运行服务器的电脑上查看弹出窗口中的实时姿态。</p>
      </div>
    </div>
    <div id="error" class="error-msg" style="display:none;"></div>
    <div id="result" style="display:none;">
      <div class="card">
        <div class="card-title" id="media-title">视频 / 峰值图像</div>
        <div class="media-container" id="media-container"></div>
      </div>
      <div class="report-buttons">
        <a href="/simple-report" class="btn btn-primary" id="btn-simple">查看简易动作报告</a>
        <a href="/comprehensive-report" class="btn btn-secondary" id="btn-comprehensive">查看综合报告</a>
      </div>
    </div>
    <div class="nav-links">
      <a href="/select-tool">← 重新选择工具与视频</a>
    </div>
  </div>
  <script>
    const params = new URLSearchParams(location.search);
    const toolId = params.get("tool") || "1";
    const videoId = params.get("video_id");
    const RUN_RESULT_KEY = "gymnastics_run_result";
    const RUN_TOOL_KEY = "gymnastics_run_tool";
    const RUN_VIDEO_ID_KEY = "gymnastics_run_video_id";

    if (videoId === null || videoId === "") {
      document.getElementById("loading").style.display = "none";
      document.getElementById("error").style.display = "block";
      document.getElementById("error").textContent = "请先选择视频。";
      document.getElementById("error").innerHTML += ' <a href="/select-file?tool=' + toolId + '">去选择视频</a>';
      throw new Error("no video");
    }

    document.getElementById("subtitle").textContent = "工具 " + toolId + " · 视频 #" + videoId;

    // If we already have result for this tool+video (e.g. back from report), show it without re-running
    const cached = sessionStorage.getItem(RUN_RESULT_KEY);
    const cachedTool = sessionStorage.getItem(RUN_TOOL_KEY);
    const cachedVideoId = sessionStorage.getItem(RUN_VIDEO_ID_KEY);
    if (cached && cachedTool === toolId && cachedVideoId === String(videoId)) {
      try {
        const data = JSON.parse(cached);
        sessionStorage.setItem(RUN_TOOL_KEY, toolId);
        sessionStorage.setItem(RUN_VIDEO_ID_KEY, String(videoId));
        document.getElementById("loading").style.display = "none";
        document.getElementById("result").style.display = "block";
        const media = document.getElementById("media-container");
        if (data.video_url) {
          const video = document.createElement("video");
          video.controls = true;
          video.src = data.video_url;
          video.style.maxWidth = "100%";
          media.appendChild(video);
        } else if (data.peak_image_url) {
          const img = document.createElement("img");
          img.src = data.peak_image_url;
          img.alt = "峰值帧";
          img.style.maxWidth = "100%";
          media.appendChild(img);
        } else {
          media.textContent = "无视频或图像可显示。";
        }
      } catch (e) { /* fall through to run */ }
    } else {
    var loadingEl = document.getElementById("loading");
    var loadingSimple = document.getElementById("loading-simple");
    var loadingSteps = document.getElementById("loading-steps");
    var isPenche = toolId === "1";
    var pencheSteps = [
      "分析姿态（MediaPipe）…",
      "审查手支撑（Gemini）…",
      "审查 relevé（Gemini）…",
      "AI 裁判评分…",
      "生成简易报告…",
      "生成综合报告…"
    ];
    var stepIndex = 0;
    var stepInterval = null;
    if (isPenche) {
      loadingSimple.style.display = "none";
      loadingSteps.style.display = "block";
      var listEl = document.getElementById("loading-steps-list");
      listEl.innerHTML = pencheSteps.map(function (text, i) {
        return "<li id=\"step-" + i + "\"><span class=\"step-spinner\"></span>" + text + "</li>";
      }).join("");
      function updateStep() {
        for (var j = 0; j < pencheSteps.length; j++) {
          var li = document.getElementById("step-" + j);
          if (!li) continue;
          var icon = li.querySelector(".step-spinner, .step-done");
          li.classList.remove("active", "done");
          if (j < stepIndex) {
            li.classList.add("done");
            if (icon) { icon.className = "step-done"; icon.textContent = "✓"; }
          } else if (j === stepIndex) {
            li.classList.add("active");
            if (icon) { icon.className = "step-spinner"; icon.textContent = ""; }
          } else {
            if (icon) { icon.className = "step-spinner"; icon.textContent = ""; }
          }
        }
      }
      stepInterval = setInterval(function () {
        stepIndex = (stepIndex + 1) % pencheSteps.length;
        updateStep();
      }, 8000);
      updateStep();
    }

    fetch("/api/run", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        tool_id: toolId,
        video_id: parseInt(videoId, 10),
        show_mediapipe_window: isPenche
      })
    })
      .then(r => r.json().then(data => ({ status: r.status, data })))
      .then(({ status, data }) => {
        if (stepInterval) clearInterval(stepInterval);
        loadingEl.style.display = "none";
        if (status !== 200 || data.error) {
          document.getElementById("error").style.display = "block";
          document.getElementById("error").textContent = data.error || "分析失败，请稍后重试。";
          return;
        }
        sessionStorage.setItem(RUN_RESULT_KEY, JSON.stringify(data));
        sessionStorage.setItem(RUN_TOOL_KEY, toolId);
        sessionStorage.setItem(RUN_VIDEO_ID_KEY, String(videoId));
        document.getElementById("result").style.display = "block";
        const media = document.getElementById("media-container");
        if (data.video_url) {
          const video = document.createElement("video");
          video.controls = true;
          video.src = data.video_url;
          video.style.maxWidth = "100%";
          media.appendChild(video);
        } else if (data.peak_image_url) {
          const img = document.createElement("img");
          img.src = data.peak_image_url;
          img.alt = "峰值帧";
          img.style.maxWidth = "100%";
          media.appendChild(img);
        } else {
          media.textContent = "无视频或图像可显示。";
        }
      })
      .catch(err => {
        if (stepInterval) clearInterval(stepInterval);
        document.getElementById("loading").style.display = "none";
        document.getElementById("error").style.display = "block";
        document.getElementById("error").textContent = "请求失败：" + (err.message || "请稍后重试。");
      });
    }
  </script>
</body>
</html>
